{% extends "spectra/base.html" %}
{% block title %}All Spectra{% endblock %}
{% block content %}
<style>
    .spectra-container {
        display: flex;
        height: 80vh;
        background: #1a2d46;
        border-radius: 8px;
        overflow: hidden;
    }

    .spectra-list-panel {
        width: 320px;
        background: #f4f6fa;
        overflow-y: auto;
        padding: 0 0 0 0;
        margin: 0;
        border-right: 2px solid #e0e4ea;
        box-shadow: 2px 0 8px rgba(26, 45, 70, 0.04);
        display: flex;
        flex-direction: column;
    }

    .spectra-list-header {
        padding: 18px 24px 10px 24px;
        font-size: 1.2em;
        font-weight: bold;
        color: #1a2d46;
        letter-spacing: 0.5px;
        background: #e9eef6;
        border-bottom: 1px solid #e0e4ea;
    }

    .spectra-list-panel ul {
        list-style: none;
        padding: 0 0 12px 0;
        margin: 0;
    }

    .spectra-list-panel li {
        margin: 0 12px 12px 12px;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(26, 45, 70, 0.06);
        background: #fff;
        transition: box-shadow 0.2s, background 0.2s;
    }

    .spectra-list-panel a {
        text-decoration: none;
        color: #1a2d46;
        display: block;
        padding: 16px 18px 12px 18px;
        border-radius: 8px;
        transition: background 0.2s, color 0.2s;
    }

    .spectra-list-panel a.selected, .spectra-list-panel a:hover {
        background: #d0e2ff;
        color: #0a1a2f;
        box-shadow: 0 2px 8px rgba(26, 45, 70, 0.10);
    }

    .spectra-list-panel .spectrum-title {
        font-size: 1.05em;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .spectra-list-panel .spectrum-meta {
        font-size: 0.92em;
        color: #5a6b8a;
        margin-bottom: 0;
    }

    .spectra-list-panel .spectrum-meta strong {
        color: #1a2d46;
    }

    .plot-panel {
        flex: 1;
        background: #1a2d46;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow-y: auto;
        min-height: 0;
    }

    #plotly-plot-refidx, #plotly-plot-abscoeff {
        width: 90%;
        min-height: 200px;
        max-height: 32vh;
        margin-bottom: 2vh;
    }

    @media (max-width: 900px) {
        .spectra-container {
            flex-direction: column;
            height: auto;
        }

        .spectra-list-panel {
            width: 100%;
            min-width: 0;
            border-right: none;
            border-bottom: 2px solid #e0e4ea;
        }

        .plot-panel {
            width: 100%;
            min-height: 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        #plotly-plot-refidx, #plotly-plot-abscoeff {
            width: 98%;
            max-height: 40vh;
            min-height: 160px;
        }
    }

    .meta-table {
        margin-top: 2em;
        color: #fff;
        background: #223355;
        border-radius: 6px;
        padding: 1em;
        width: 90%;
    }

    .meta-table th, .meta-table td {
        padding: 0.3em 1em;
        text-align: left;
    }

    .meta-table th {
        font-weight: bold;
        width: 30%;
        color: #1a2d46;
    }

    .filter-dropdown {
        margin-bottom: 18px;
        width: 100%;
    }

    .filter-summary {
        font-size: 1.1em;
        font-weight: 600;
        color: #1a2d46;
        background: #e9eef6;
        border: 1px solid #e0e4ea;
        border-radius: 6px;
        padding: 10px 18px;
        cursor: pointer;
        transition: background 0.2s;
        outline: none;
    }

    .filter-summary:focus, .filter-summary:hover {
        background: #d0e2ff;
    }

    .filter-content {
        padding: 18px 18px 8px 18px;
        background: #f4f6fa;
        border: 1px solid #e0e4ea;
        border-top: none;
        border-radius: 0 0 6px 6px;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }

    .filter-content > div {
        display: flex;
        flex-direction: column;
        min-width: 180px;
        margin-bottom: 8px;
    }

    .filter-content label {
        font-weight: 600;
        margin-bottom: 4px;
        color: #1a2d46;
    }

    .filter-content input {
        border: 1px solid #c0c8d6;
        border-radius: 4px;
        padding: 6px 8px;
        background: #fff;
        color: #1a2d46;
    }

    .filter-actions {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        margin-top: 8px;
    }
</style>
<details class="filter-dropdown" {% if request.GET %}open{% endif %}>
    <summary class="filter-summary">Filter Spectra</summary>
    <form method="get" class="filter-content">
        <div>
            <label for="{{ filter_form.name.id_for_label }}">{{ filter_form.name.label }}</label>
            {{ filter_form.name }}
        </div>
        <div>
            <label for="{{ filter_form.uploaded_by.id_for_label }}">{{ filter_form.uploaded_by.label }}</label>
            {{ filter_form.uploaded_by }}
        </div>
        <div>
            <label for="{{ filter_form.upload_date_to.id_for_label }}">{{ filter_form.upload_date_to.label }}</label>
            {{ filter_form.upload_date_to }}
        </div>
        <div>
            <label for="{{ filter_form.upload_date_to.id_for_label }}">{{ filter_form.upload_date_to.label }}</label>
            {{ filter_form.upload_date_to }}
        </div>
        <div>
            <label for="{{ filter_form.meta_key.id_for_label }}">{{ filter_form.meta_key.label }}</label>
            {{ filter_form.meta_key }}
        </div>
        <div>
            <label for="{{ filter_form.meta_value.id_for_label }}">{{ filter_form.meta_value.label }}</label>
            {{ filter_form.meta_value }}
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary" style="padding: 8px 18px;">Filter</button>
            <a href="{% url 'spectra:spectrum_list' %}" class="btn btn-secondary" style="padding: 8px 18px;">Reset</a>
        </div>
    </form>
</details>
<div class="spectra-container">
    <div class="spectra-list-panel">
        <div class="spectra-list-header">Spectra</div>
        <ul>
            {% for spectrum in spectra %}
            <li>
                <a href="{% url 'spectra:spectrum_detail' spectrum.pk %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}"
                   class="{% if selected_spectrum and selected_spectrum.pk == spectrum.pk %}selected{% endif %}">
                    <div class="spectrum-title">{{ spectrum.material.name }}</div>
                    <div class="spectrum-meta">
                        Uploaded: <strong>{{ spectrum.upload_timestamp|date:"Y-m-d H:i" }}</strong>
                        {% if spectrum.uploaded_by %}
                        <br>by <strong>{{ spectrum.uploaded_by.username }}</strong>
                        {% endif %}
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="plot-panel" style="flex-direction:column;">
        <div id="plotly-plot-refidx" style="width:90%;height:28vh;margin-bottom:2vh;"></div>
        <div id="plotly-plot-abscoeff" style="width:90%;height:28vh;"></div>
        {% if meta_data %}
        <table class="meta-table">
            <tbody>
            {% for key, value in meta_data.items %}
            <tr>
                <th>{{ key }}</th>
                <td>{{ value }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    window.addEventListener('resize', function () {
        Plotly.Plots.resize('plotly-plot-refidx');
        Plotly.Plots.resize('plotly-plot-abscoeff');
    });
    var fig_refidx = {{ plotly_fig_refidx|safe }};
    var fig_abscoeff = {{ plotly_fig_abscoeff|safe }};
    Plotly.newPlot('plotly-plot-refidx', fig_refidx.data, fig_refidx.layout);
    Plotly.newPlot('plotly-plot-abscoeff', fig_abscoeff.data, fig_abscoeff.layout);
    // Scroll selected entry into view
    document.addEventListener('DOMContentLoaded', function() {
    var selected = document.querySelector('.spectra-list-panel a.selected');
    if (selected) {
      selected.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    });
</script>
{% endblock %}