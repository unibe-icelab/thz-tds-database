{% extends "spectra/base.html" %}

{% block title %}Upload Spectrum{% endblock %}

{% block content %}
<h1>Upload New Spectrum</h1>

{% if form.non_field_errors %}
    <div class="alert alert-danger mt-3">
        {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
        {% endfor %}
    </div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    {# Material Field - Common to both options #}
    <div class="form-group mb-3">
        <label for="{{ form.material.id_for_label }}" class="form-label">{{ form.material.label }}</label>
        {{ form.material }}
        {% if form.material.errors %}
            {% for error in form.material.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {% if form.material.help_text %}
            <small class="form-text text-muted">{{ form.material.help_text|safe }}</small>
        {% endif %}
    </div>

    <hr class="my-4">
    <h4>Option 1: Upload Combined Data and Metadata File (Recommended)</h4>
    <p class="text-muted"><small>Use this option to upload a single file that contains both the spectral data (frequency, intensity) and its associated metadata.</small></p>

    {# Binary Data File Field #}
    <div class="form-group mb-3">
        <label for="{{ form.binary_data_file.id_for_label }}" class="form-label">{{ form.binary_data_file.label }}</label>
        {{ form.binary_data_file }}
        {% if form.binary_data_file.errors %}
            {% for error in form.binary_data_file.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {% if form.binary_data_file.help_text %}
            <small class="form-text text-muted">{{ form.binary_data_file.help_text|safe }}</small>
        {% endif %}
    </div>

    <hr class="my-4">
    <h4>Option 2: Upload CSV File and Enter Metadata Manually (Alternative)</h4>
    <p class="text-muted"><small>Use this option if you have spectral data in a CSV file and wish to enter metadata separately as JSON text.</small></p>

    {# CSV Data File Field #}
    <div class="form-group mb-3">
        <label for="{{ form.data_file.id_for_label }}" class="form-label">{{ form.data_file.label }}</label>
        {{ form.data_file }}
        {% if form.data_file.errors %}
            {% for error in form.data_file.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {% if form.data_file.help_text %}
            <small class="form-text text-muted">{{ form.data_file.help_text|safe }}</small>
        {% endif %}
    </div>

    {# Metadata JSON Text Field #}
    <div class="form-group mb-3">
        <label for="{{ form.metadata_json_text.id_for_label }}" class="form-label">{{ form.metadata_json_text.label }}</label>
        {{ form.metadata_json_text }}
        {% if form.metadata_json_text.errors %}
            {% for error in form.metadata_json_text.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {% if form.metadata_json_text.help_text %}
            <small class="form-text text-muted">{{ form.metadata_json_text.help_text|safe }}</small>
        {% endif %}
    </div>
    <hr class="my-4">

    {# Notes Field - Common to both options #}
    <div class="form-group mb-3">
        <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
        {{ form.notes }}
        {% if form.notes.errors %}
            {% for error in form.notes.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {% if form.notes.help_text %}
            <small class="form-text text-muted">{{ form.notes.help_text|safe }}</small>
        {% endif %}
    </div>

    <button type="submit" class="btn btn-primary mt-3">Upload Spectrum</button>
</form>
<br>
<p>
    <a href="{% if form.initial.material %}{% url 'spectra:material_detail' pk=form.initial.material.pk %}{% else %}{% url 'spectra:spectrum_list' %}{% endif %}" class="btn btn-secondary">
        Cancel
    </a>
</p>
{% endblock %}