{% extends "spectra/base.html" %}

{% block title %}Upload Spectrum{% endblock %}

{% block content %}
<h1>Upload New Spectrum</h1>

{% if form.non_field_errors %}
    <div class="alert alert-danger mt-3">
        {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
        {% endfor %}
    </div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    {# Material Name Field - Changed from form.material to form.material_name #}
    <div class="form-group mb-3">
        <label for="{{ form.material_name.id_for_label }}" class="form-label">{{ form.material_name.label }}</label>
        {{ form.material_name }}
        {% if form.material_name.help_text %}
            <small class="form-text text-muted">{{ form.material_name.help_text|safe }}</small>
        {% endif %}
        {% for error in form.material_name.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
        <>{% endfor %}</>
    </div>

    <hr class="my-4">
    <h4>Option 1: Upload Combined Data and Metadata File (Recommended)</h4>
    <p class="text-muted"><small>Use this option to upload a single file that contains both the spectral data (frequency, intensity) and its associated metadata.</small></p>

    {# Binary Data File Field #}
    <div class="form-group mb-3">
        <label for="{{ form.binary_data_file.id_for_label }}" class="form-label">{{ form.binary_data_file.label }}</label>
        {{ form.binary_data_file }}
        {% if form.binary_data_file.help_text %}
            <small class="form-text text-muted">{{ form.binary_data_file.help_text|safe }}</small>
        {% endif %}
        {% for error in form.binary_data_file.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
        {% endfor %}
    </div>

    <hr class="my-4">
    <h4>Option 2: Upload CSV File and Enter Metadata Manually (Alternative)</h4>
    <p class="text-muted"><small>Use this option if you have spectral data in a CSV file and wish to enter metadata separately as JSON text.</small></p>

    {# CSV Data File Field #}
    <div class="form-group mb-3">
        <label for="{{ form.data_file.id_for_label }}" class="form-label">{{ form.data_file.label }}</label>
        {{ form.data_file }}
        {% if form.data_file.help_text %}
            <small class="form-text text-muted">{{ form.data_file.help_text|safe }}</small>
        {% endif %}
        {% for error in form.data_file.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
        {% endfor %}
    </div>

    {# Metadata JSON Text Field #}
    <div class="form-group mb-3">
        <label for="{{ form.metadata_json_text.id_for_label }}" class="form-label">{{ form.metadata_json_text.label }}</label>
        {{ form.metadata_json_text }}
        {% if form.metadata_json_text.help_text %}
            <small class="form-text text-muted">{{ form.metadata_json_text.help_text|safe }}</small>
        {% endif %}
        {% for error in form.metadata_json_text.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
        {% endfor %}
    </div>
    <hr class="my-4">

    <button type="submit" class="btn btn-primary mt-3">Upload Spectrum</button>
</form>
<br>
<p>
    {# Ensure this link works correctly if form.initial.material is no longer relevant #}
    {# You might want to adjust this based on whether 'material_name' could be pre-filled #}
    <a href="{% url 'spectra:spectrum_list' %}" class="btn btn-secondary">
        Cancel
    </a>
</p>
{% endblock %}